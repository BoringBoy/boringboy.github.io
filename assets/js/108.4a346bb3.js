(window.webpackJsonp=window.webpackJsonp||[]).push([[108],{444:function(s,n,a){"use strict";a.r(n);var t=a(7),e=Object(t.a)({},(function(){var s=this,n=s._self._c;return n("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[n("h1",{attrs:{id:"nginx通过四层代理实现端口转发"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#nginx通过四层代理实现端口转发"}},[s._v("#")]),s._v(" nginx通过四层代理实现端口转发")]),s._v(" "),n("h2",{attrs:{id:"概念"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#概念"}},[s._v("#")]),s._v(" 概念")]),s._v(" "),n("p",[s._v("四层代理工具（Layer 4 Proxy）是一种网络代理技术，它在传输层（Transport Layer）进行操作，代理网络连接，对网络流量进行转发和负载均衡。")]),s._v(" "),n("p",[s._v("四层代理工具通常用于 TCP 和 UDP 协议，例如代理 TCP 指向 Web 服务器的连接或者 UDP 数据流。")]),s._v(" "),n("h2",{attrs:{id:"背景"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#背景"}},[s._v("#")]),s._v(" 背景")]),s._v(" "),n("p",[s._v("公司原有的测试数据库在主机192.168.1.5上边，现在数据库转移到了192.168.1.4上，\n在尽可能不改动其它配置的情况下的快速完成迁移需求，我能想到的合理的办法就是做一个四层代理，将原来请求到192.168.1.5的3306端口转发到192.168.1.4的3306端口。")]),s._v(" "),n("p",[s._v("通过官方文档，可以得知：Nginx中四层代理依赖模块 "),n("code",[s._v("ngx_stream_core_module，")]),s._v("该模块自 1.9.0 版开始可用。默认情况下，此模块不构建，应使用配置参数启用 "),n("code",[s._v("--with-stream")]),s._v("。")]),s._v(" "),n("h2",{attrs:{id:"准备工作"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#准备工作"}},[s._v("#")]),s._v(" 准备工作")]),s._v(" "),n("ul",[n("li",[s._v("安装Nginx并启用"),n("code",[s._v("--with-stream")]),s._v("模块")])]),s._v(" "),n("p",[s._v("安装步骤大致如下：")]),s._v(" "),n("div",{staticClass:"language-shell line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-shell"}},[n("code",[n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@linux-node1 src"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# tar xf nginx-1.10.3.tar.gz ")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@linux-node1 src"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# cd nginx-1.10.3")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@linux-node1 nginx-1.10.3"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# useradd -s /sbin/nologin -M www")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@linux-node1 nginx-1.10.3"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# yum install gcc gcc-c++ zlib-devel pcre-devel openssl openssl-devel -y")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@linux-node1 nginx-1.10.3"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# ./configure --prefix=/usr/local/nginx-1.10.3 --user=www --group=www \\ ")]),s._v("\n--with-http_ssl_module --with-http_stub_status_module --with-file-aio --with-stream\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@linux-node1 nginx-1.10.3"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# make && make install ")]),s._v("\n\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br")])]),n("p",[s._v("可以通过"),n("code",[s._v("nginx -V")]),s._v("查看一下是否将上述模块编译进来，如果没有，可以重新编译一下。")]),s._v(" "),n("h2",{attrs:{id:"开始配置"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#开始配置"}},[s._v("#")]),s._v(" 开始配置")]),s._v(" "),n("ul",[n("li",[s._v("简单配置测试下 "),n("code",[s._v("nginx.conf")]),s._v(" 文件")])]),s._v(" "),n("div",{staticClass:"language-conf line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v("worker_processes  1;\nevents {\n    worker_connections  1024;\n}\nstream {  \n        upstream tcp_proxy {\n        hash $remote_addr consistent;  #远程地址做个hash\n        server 192.168.1.4:22;\n   }\n      server {\n        listen 2222;\n        proxy_connect_timeout 1s;\n        proxy_timeout 10s;  #后端连接超时时间\n        proxy_pass tcp_proxy;\n     }\n  }\n\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br"),n("span",{staticClass:"line-number"},[s._v("12")]),n("br"),n("span",{staticClass:"line-number"},[s._v("13")]),n("br"),n("span",{staticClass:"line-number"},[s._v("14")]),n("br"),n("span",{staticClass:"line-number"},[s._v("15")]),n("br"),n("span",{staticClass:"line-number"},[s._v("16")]),n("br"),n("span",{staticClass:"line-number"},[s._v("17")]),n("br")])]),n("p",[s._v("上面的配置是将本机的 2222 端口转发到 192.168.1.4 的 22 端口，配置之后，试验结果：通过了。")]),s._v(" "),n("p",[s._v("同理，开始配置数据库端口的转发。我们按照上面的配置，稍加改动下：")]),s._v(" "),n("div",{staticClass:"language-conf line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v("worker_processes  1;\nevents {\n    worker_connections  1024;\n}\nstream {  \n        upstream tcp_proxy {\n        hash $remote_addr consistent;  #远程地址做个hash\n        server 192.168.1.4:3306;\n   }\n      server {\n        listen 3306;\n        proxy_connect_timeout 1s;\n       # proxy_timeout 10s;  #后端连接超时时间\n        proxy_pass tcp_proxy;\n     }\n  }\n\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br"),n("span",{staticClass:"line-number"},[s._v("12")]),n("br"),n("span",{staticClass:"line-number"},[s._v("13")]),n("br"),n("span",{staticClass:"line-number"},[s._v("14")]),n("br"),n("span",{staticClass:"line-number"},[s._v("15")]),n("br"),n("span",{staticClass:"line-number"},[s._v("16")]),n("br"),n("span",{staticClass:"line-number"},[s._v("17")]),n("br")])]),n("p",[s._v("这样一来，用户连接192.168.1.5:3306的时候，就会被转发到192.168.1.4:3306了。")])])}),[],!1,null,null,null);n.default=e.exports}}]);